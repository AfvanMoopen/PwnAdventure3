import struct

def h_noop(data):
    return data

def h_position(data):
    X,Y,Z = struct.unpack("fff", data[0:3*4])
    #print "{:.2f} / {:.2f} / {:.2f}".format(X,Y,Z)
    return data[20:]

def h_jump(data):
    jump = struct.unpack("B", data[0])[0]
    print "jump: {}".format(jump)
    return data[1:]

def h_weapon_change(data):
    weapon_change = struct.unpack("B", data[0])[0]
    print "weapon_change: {}".format(weapon_change)
    return data[1:]

def h_static_link(data):
    static_link = struct.unpack("B", data[0])[0]
    print "static_link: {}".format(static_link)
    return data[1:]

def h_shoot(data):
    length = struct.unpack("H", data[0:2])[0]
    name = data[2:2+length]
    direction = data[2+length:2+length+12]
    print "weapon({}) {}".format(length, name)
    return data[2+length+12:]

handlers = {
    0x6d76: h_position,
    0x6a70: h_jump,
    0x733d: h_weapon_change,
    0x6672: h_static_link,
    0x2a69: h_shoot,
}

def parse(data, port, origin):
    if port==3333:
        return
    if origin == 'server':
        return
    while len(data)>0:
        packet_id = struct.unpack(">H", data[0:2])[0]
        if packet_id not in handlers:
            print "[{}] {}".format(origin, data.encode('hex'))
        data = handlers.get(packet_id, h_noop)(data[2:])

"""
FB: 2a69 10 00 477265617442616c6c734f6646697265 6a359f40a44c794200000000
FB: 2a69 10 00 477265617442616c6c734f6646697265 82b4394054a1b8c2327a6535
SL: 2a69 0a 00 5374617469634c696e6b             82b4394054a1b8c2327a6535      
RE: 2a69 0d 00 52656d6f74654578706c6f6974       82b4394054a1b8c2327a6535      

unknown packet: 016d76655d2747012b604719df95449a04e70b00000000
unknown packet: 006d76655d2747012b6047ef1ea1449a04e70b00000000
unknown packet: 016d76655d2747012b6047ddb4b1449a04e70b00000000
unknown packet: 006d76655d2747012b6047bbcf17459a04e70b00000000
unknown packet: 016d76655d2747012b60471a2b20459a04e70b00000000
unknown packet: 006d76655d2747012b6047181c60459a04e70b00000000

[client(3002)] 6a70016d760c372c4790104a477e0bfa43a9015db100000000
[client(3002)] 6a70006d760c372c4790104a47fe781b44a9015db100000000

jump: 1 | 6d76655d2747012b604725c8f244b6f7af3b00000000
jump: 0 | 6d76655d2747012b604752a91445b6f7af3b00000000
jump: 1 | 6d76655d2747012b6047bbce3645b6f7af3b00000000
jump: 0 | 6d76655d2747012b60472f665345b6f7af3b00000000

walking:
               id   x        y        z        looking  ?    key
[client(3002)] 6d76 a0722d47 092a4b47 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 da702d47 50254b47 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 7a6c2d47 aa194b47 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 a45a2d47 27ea4a47 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 973c2d47 169a4a47 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 a70d2d47 111d4a47 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 d0d12c47 b47d4947 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 6b952c47 d9dc4847 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 1e512c47 ec264847 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 8bfb2b47 02434747 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 9aa92b47 c3684647 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 671f2b47 b1f84447 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 05b02a47 08d04347 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 457c2a47 32464347 cc4cc542 a9015db1 0000 7f00
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000
[client(3002)] 6d76 b75c2a47 25f24247 cc4cc542 a9015db1 0000 0000

walking:

[client(3002)] 6d76 21eb3047784c48 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 abd83047685348 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 97b53047956048 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 236730470b7e48 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 22163047749c48 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 4be02f47aab048 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 327a2f47fed648 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 a7d52e47c51449 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 90002e47c66449 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 0c762d47c89849 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 1a722c4763fa49 47cc4cc542a9015db10000 0081
[client(3002)] 6d76 5b3e2c47d10d4a 47cc4cc542a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a 47cc4cc542a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a 47cc4cc542a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a 47cc4cc542a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a 47cc4cc542a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a 47cc4cc542a9015db10000 0000

jumping:

[client(3002)] 6a70016d760c372c4790104a477e0bfa43a9015db100000000
[client(3002)] 6a70006d760c372c4790104a47fe781b44a9015db100000000

[client(3002)] 6d76 0c372c4790104a47 f648fd43 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 036c0b44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 1b234144 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 b8c44d44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 f6f85744 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 d3226844 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 10247144 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 ffc27544 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 11f87a44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 ea197c44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 36627b44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 f1317a44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 c67d7744 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 31b06c44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 d2645c44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 73364b44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 de014144 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 e4153544 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 c6d71a44 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 1a44f743 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 254cb343 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 bc3c8c43 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 9efbcd42 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000
[client(3002)] 6d76 0c372c4790104a47 cd4cc542 a9015db10000 0000



looking around:
               id   x        y        z        looking  ?    key
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 1d0ad6ca 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 1909b9cb 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 50072ccc 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 690515cc 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 6902f1c9 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 2101eec7 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 5a00d6c5 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 2d00d7c4 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 abff34c2 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 afff79c0 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 4100bbbe 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 ed0084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 ed0084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 ed0084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 d60084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 d60084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 d60084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 d60084bd 0000 0000
[client(3002)] 6d76 0c372c47 90104a47 cc4cc542 d60084bd 0000 0000
"""
